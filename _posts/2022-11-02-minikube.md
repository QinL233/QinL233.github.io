---
title: 'minikube'
layout: post
tags:
  - linux
category: linux
---
k8s单机版。

<!--more-->

# 一、安装命令
https://minikube.sigs.k8s.io/docs/start/


## 1、直接安装minikube
```
curl -Lo minikube https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.23.1/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/
```
## 2、启动minikube：默认会使用docker容器。

```minikube start```
或
```minikube start --force --driver=docker```

### docker做驱动无法对外机器访问，mac可以是使用：

```
minikube start --driver='hyperkit' --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers' --vm=true
```
#### kyperkit安装
```
curl -LO https://storage.googleapis.com/minikube/releases/latest/docker-machine-driver-hyperkit && chmod +x docker-machine-driver-hyperkit && sudo mv docker-machine-driver-hyperkit /usr/local/bin/ && sudo chown root:wheel /usr/local/bin/docker-machine-driver-hyperkit && sudo chmod u+s /usr/local/bin/docker-machine-driver-hyperkit

# 查看安装状态
ll /usr/local/bin/ | grep docker-machine-driver-hyperkit

# 安装
brew install /usr/local/bin/docker-machine-driver-hyperkit

```



## 3、让minikube下载kubectl客户端命令工具
```minikube kubectl -- get po -A```

## 4、设置别名kubectl代替minikube kubectl -- 
```alias kubectl="minikube kubectl --"```

## 5、为dashboard添加外部访问代理
```
minikube kubectl -- proxy --port=8001 --address='0.0.0.0' --accept-hosts='^.*' &
```
## 6、启动控制台UI
```minikube dashboard --url```

# 二、常用命令

1、启动集群```minikube start```

2、查看集群状态```minikube status```

3、访问在 minikube 集群中运行的 kubernetes dashboard```minikube dashboard```

4、停止集群中的容器```minikube pause```

5、恢复集群中的容器```minikube unpuase```

6、查看虚拟机ip```minikube ip```

7、登陆到虚拟机```minikube ssh```

8、删除集群```minikube delete```

# 三、插件安装

1、查询插件列表```minikube addons list```

2、启动置顶插件```minikube addons enable <name>``` or ``` minikube start --addons <name1> --addons <name2>```

3、停用插件```minikube addons disable <name>```

# 四、配置aliyun镜像仓库

在阿里云控制台创建仓库：https://cr.console.aliyun.com

1、登录阿里云
```docker login --username=xxx@hotmail.com registry.cn-hangzhou.aliyuncs.com```

2、在master上生成密钥
```
kubectl create secret docker-registry alidockerregistryssecret --docker-server=registry.cn-hangzhou.aliyuncs.com --docker-username=xxx --docker-password=xxx [--docker-email=xxxx@xxx.com]
```

3、添加密钥到namespace
```
kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "alidockerregistryssecret"}]}'
```

4、修改启动的xxx.yml,在kubectl apply -f xxx.yml
给spec:template:下的容器配置secrets
```
spec:
  serviceAccountName: default
  imagePullSecrets:
    - name: alidockerregistryssecret
  containers:
    - image: registry.cn-hangzhou.aliyuncs.com/qzliao/app:h5-cc-1.0.1
      name: go
      imagePullPolicy: Always
      command: ["./main","-v","v1.0.1"]
      ports:
        - containerPort: 8404
          protocol: TCP

```

# 五、注意事项
## 启动出错：
/proc/sys/net/bridge/bridge-nf-call- iptables does not exist

1、执行```modprobe br_netfilter```

2、```vim /etc/sysctl.conf``` 添加以下内容后执行 ```sysctl -p```
```
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
```

# 部署APP
1、启动service后使用命令查看对外映射的url:
```
minikube service [service-name] --url

kubectl get service <service-name> --output='jsonpath="{.spec.ports[0].nodePort}"'
```
查看[service-name]```kubectl get server``` 

2、查看service映射外部的端口
```
minikube kubectl -- get service
```
3、使用命令转发service
```
kubectl port-forward [service] 9080:80
```
