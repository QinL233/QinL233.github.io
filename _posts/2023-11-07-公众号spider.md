---
title: '公众号文章爬取'
layout: post
tags:
  - 爬虫
  - python
category: 爬虫
---
公众号文章爬取

<!--more-->
# 一、获取文章列表（最新10条）【重点：wap_sid2】
## 1、获取公众号历史列表网页
【url】：https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI2NDI5NzkwNA==
【微信打开url】：https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI2NDI5NzkwNA==&uin=OTA4NzMzNTIx&key=bdb15eb8b0eb27ca63cacffa8cd9033d8745e43106ea5fc3eb70b5c6a67a5ba99ebbe5ea705d55e468134cce5d4f8c37455e0bf55183be8b64f257d10a99f6539219d494391fb4b62fec384b4857dd75aae4646119fbd2f162fe7d72e743825d35f3418011983d500bdbf798686a576399fae3dd841611693357d5b4deb6df03&devicetype=Windows%2010%20x64&version=6309071d&lang=zh_CN&a8scene=1&acctmode=0&pass_ticket=Le5qqlqxWLXK5fmOrzvO+nIhwA6fzw1WQR/FxIt4Xgr0qZy5A2Ulktlvbfed1RnRrb6RJtgPXBV+LtiaPGpL0g==&wx_header=1
### 在线网站获取法
地址：https://wx.okhelp.xyz/
![微信截图_20231113173345](https://raw.githubusercontent.com/QinL233/QinL233.github.io/master/images/微信截图_20231113173345.png)

### 打开文章后使用抓包分析__biz
![微信截图_20231113173454](https://raw.githubusercontent.com/QinL233/QinL233.github.io/master/images/微信截图_20231113173454.png)

## 2、破解`微信客户端打开`

### 公众号权限标识：cookie:wap_sid2
![微信图片_20231113173848](https://raw.githubusercontent.com/QinL233/QinL233.github.io/master/images/微信图片_20231113173848.png)

## 3、解析出文章列表
* 文件中携带了文章的json（最新10篇），通过解析json可以获取列表（需要html转义）
![微信截图_20231113174040](https://raw.githubusercontent.com/QinL233/QinL233.github.io/master/images/微信截图_20231113174040.png)

# 二、获取历史文章【重点：key、appmsg_token】
* 未认证请求在滚动到底部时，无法获取历史文章
![微信截图_20231113174543](https://raw.githubusercontent.com/QinL233/QinL233.github.io/master/images/微信截图_20231113174543.png)
【url】：https://mp.weixin.qq.com/mp/profile_ext?action=getmsg&__biz=MzI2NDI5NzkwNA==&f=json&offset=10&count=10&is_ok=1&scene=&uin=OTA4NzMzNTIx&key=bdb15eb8b0eb27ca63cacffa8cd9033d8745e43106ea5fc3eb70b5c6a67a5ba99ebbe5ea705d55e468134cce5d4f8c37455e0bf55183be8b64f257d10a99f6539219d494391fb4b62fec384b4857dd75aae4646119fbd2f162fe7d72e743825d35f3418011983d500bdbf798686a576399fae3dd841611693357d5b4deb6df03&pass_ticket=Le5qqlqxWLXK5fmOrzvO%26amp%3Bnbsp%3BnIhwA6fzw1WQR%2FFxIt4Xgr0qZy5A2Ulktlvbfed1RnRrb6RJtgPXBV%26amp%3Bnbsp%3BLtiaPGpL0g%3D%3D&wxtoken=&appmsg_token=1243_aauo9%252F46eSnMi90toDXPXNsIMTbv7F1A8t8DFw~~&x5=0&f=json
## 数据结构分析
mp/profile_ext
?action=getmsg
&__biz=MzI2NDI5NzkwNA==
&f=json
&offset=10
&count=10
&is_ok=1
&scene=
&uin=OTA4NzMzNTIx
&key=bdb15eb8b0eb27ca63cacffa8cd9033d8745e43106ea5fc3eb70b5c6a67a5ba99ebbe5ea705d55e468134cce5d4f8c37455e0bf55183be8b64f257d10a99f6539219d494391fb4b62fec384b4857dd75aae4646119fbd2f162fe7d72e743825d35f3418011983d500bdbf798686a576399fae3dd841611693357d5b4deb6df03
&pass_ticket=Le5qqlqxWLXK5fmOrzvO%26amp%3Bnbsp%3BnIhwA6fzw1WQR%2FFxIt4Xgr0qZy5A2Ulktlvbfed1RnRrb6RJtgPXBV%26amp%3Bnbsp%3BLtiaPGpL0g%3D%3D
&wxtoken=
&appmsg_token=1243_aauo9%252F46eSnMi90toDXPXNsIMTbv7F1A8t8DFw~~
&x5=0
&f=json

## 规则分析
* action=getmsg表示返回json格式
* __biz表示公众号id（唯一不变）
* 详细需要使用&f=json包裹并且入参
* uin一般不变
* key与获取文章列表对应【重点】
* appmsg_token需要通过文章列表打开时获取【重点】
* pass_ticket可以为空

## 结论
需要在action=home(文章列表获取前)获得认证码
* cookie：wap_sid2 用于第一步跳过微信客户端打开
* query：key 携带key用于在获取文章列表后，得到appmsg_token
* query：appmsg_token 传递appmsg_token即可得到文章列表json